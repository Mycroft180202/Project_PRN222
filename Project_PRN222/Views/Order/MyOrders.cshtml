@model List<Project_PRN222.Models.Order>
@{
    ViewData["Title"] = "My Orders - EShopper";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Page Header Start -->
<div class="container-fluid bg-secondary mb-5">
    <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 300px">
        <h1 class="font-weight-semi-bold text-uppercase mb-3">My Orders</h1>
        <div class="d-inline-flex">
            <p class="m-0"><a href="/">Home</a></p>
            <p class="m-0 px-2">-</p>
            <p class="m-0">My Orders</p>
        </div>
    </div>
</div>
<!-- Page Header End -->

<!-- Orders Start -->
<div class="container-fluid pt-5">
    <div class="row px-xl-5">
        <div class="col-lg-12 table-responsive mb-5">
            @if (Model != null && Model.Any())
            {
                <table class="table table-bordered text-center mb-0">
                    <thead class="bg-secondary text-dark">
                        <tr>
                            <th>Order ID</th>
                            <th>Date</th>
                            <th>Total Amount</th>
                            <th>Status</th>
                            <th>Payment Method</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody class="align-middle">
                        @foreach (var order in Model)
                        {
                            <tr>
                                <td class="align-middle">#@order.OrderId</td>
                                <td class="align-middle">@(order.OrderDate?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                                <td class="align-middle">@order.TotalAmount.ToString("N0") VND</td>
                                <td class="align-middle">
                                    @{
                                        string badgeClass = "badge ";
                                        switch (order.OrderStatus)
                                        {
                                            case "Pending":
                                                badgeClass += "bg-warning text-dark";
                                                break;
                                            case "Confirmed":
                                                badgeClass += "bg-info text-white";
                                                break;
                                            case "Shipped":
                                                badgeClass += "bg-primary text-white";
                                                break;
                                            case "Delivered":
                                                badgeClass += "bg-success text-white";
                                                break;
                                            case "Cancelled":
                                                badgeClass += "bg-danger text-white";
                                                break;
                                            default:
                                                badgeClass += "bg-secondary text-white";
                                                break;
                                        }
                                    }
                                    <span class="@badgeClass">@order.OrderStatus</span>
                                </td>
                                <td class="align-middle">@(order.PaymentMethod ?? "N/A")</td>
                                <td class="align-middle">
                                    <button class="btn btn-sm btn-primary view-order-details" 
                                            data-id="@order.OrderId">
                                        <i class="fa fa-eye"></i> View Details
                                    </button>
                                    @if (order.OrderStatus == "Pending")
                                    {
                                        <button class="btn btn-sm btn-danger cancel-order" 
                                                data-id="@order.OrderId">
                                            <i class="fa fa-times"></i> Cancel
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div class="text-center py-5">
                    <h3 class="font-weight-semi-bold mb-4">You haven't placed any orders yet</h3>
                    <p>Browse our products and place your first order!</p>
                    <a href="/Home/Shop" class="btn btn-primary py-2 px-4">Shop Now</a>
                </div>
            }
        </div>
    </div>
</div>
<!-- Orders End -->

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailsModalLabel">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="orderDetailsContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // View order details
            $('.view-order-details').on('click', function() {
                var orderId = $(this).data('id');
                $('#orderDetailsModalLabel').text('Order #' + orderId + ' Details');
                $('#orderDetailsContent').html('<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>');
                $('#orderDetailsModal').modal('show');
                
                $.ajax({
                    url: `/${orderId}/details`,
                    method: 'GET',
                    success: function(orderDetails) {
                        var statusBadgeClass = getStatusBadgeClass(orderDetails.orderStatus);
                        var modalContent = `
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6>Order Information</h6>
                                    <p><strong>Order Date:</strong> ${new Date(orderDetails.orderDate).toLocaleString()}</p>
                                    <p><strong>Status:</strong> <span class="badge ${statusBadgeClass}">${orderDetails.orderStatus}</span></p>
                                    <p><strong>Payment Method:</strong> ${orderDetails.paymentMethod || 'N/A'}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Shipping Information</h6>
                                    <p><strong>Shipping Address:</strong> ${orderDetails.shippingAddress || 'N/A'}</p>
                                    <p><strong>Billing Address:</strong> ${orderDetails.billingAddress || 'Same as shipping address'}</p>
                                </div>
                            </div>
                            <h6>Order Items</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Price</th>
                                            <th>Quantity</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>`;
                        
                        orderDetails.orderItems.forEach(function(item) {
                            modalContent += `
                                <tr>
                                    <td>${item.product ? item.product.productName : `Product #${item.productId}`}</td>
                                    <td>${parseFloat(item.price).toLocaleString('vi-VN')} VND</td>
                                    <td>${item.quantity}</td>
                                    <td>${parseFloat(item.price * item.quantity).toLocaleString('vi-VN')} VND</td>
                                </tr>`;
                        });
                        
                        modalContent += `
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="3" class="text-end"><strong>Subtotal:</strong></td>
                                            <td>${parseFloat(orderDetails.totalAmount).toLocaleString('vi-VN')} VND</td>
                                        </tr>
                                        <tr>
                                            <td colspan="3" class="text-end"><strong>Shipping:</strong></td>
                                            <td>30,000 VND</td>
                                        </tr>
                                        <tr>
                                            <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                            <td>${parseFloat(orderDetails.totalAmount + 30000).toLocaleString('vi-VN')} VND</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>`;
                        
                        $('#orderDetailsContent').html(modalContent);
                    },
                    error: function(xhr) {
                        $('#orderDetailsContent').html(`<div class="alert alert-danger">Error loading order details: ${xhr.responseText || 'Unknown error'}</div>`);
                    }
                });
            });
            
            // Cancel order
            $('.cancel-order').on('click', function() {
                var orderId = $(this).data('id');
                
                if (confirm('Are you sure you want to cancel this order?')) {
                    $.ajax({
                        url: `/api/Order/${orderId}/cancel`,
                        method: 'PUT',
                        success: function() {
                            alert('Order cancelled successfully!');
                            location.reload();
                        },
                        error: function(xhr) {
                            alert('Error cancelling order: ' + (xhr.responseJSON?.message || xhr.statusText));
                        }
                    });
                }
            });
            
            // Helper function to get badge class based on order status
            function getStatusBadgeClass(status) {
                switch(status) {
                    case 'Pending': return 'bg-warning text-dark';
                    case 'Confirmed': return 'bg-info text-white';
                    case 'Shipped': return 'bg-primary text-white';
                    case 'Delivered': return 'bg-success text-white';
                    case 'Cancelled': return 'bg-danger text-white';
                    default: return 'bg-secondary text-white';
                }
            }
        });
    </script>
}